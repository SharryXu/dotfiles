#!/usr/bin/env bash -l

# TODO: 1.Add parameter to deal Depth

# Sync git repository.
# Globals:
#   print
#   git
# Arguments:
#   Folder Path
#   Remote Repository Name
#   Remote Repository Path
#   Branch Name (Optional)
#   Depth (Optional)
# Returns:
#   None

function usage() {
  echo -e "\nusage: $(basename $0) [options] local_folder_path

[options]:
-r  remote repository path
    For example: https://github.com/SharryXu/dotfiles
-b  branch. Default value is master.
-s  source name. Default value is origin.
-t  target name. Default value is origin.
-h  help information.

Warning: For now, we assume the branch name in source and target are the same."
  exit 1
}

branch="master"
source_name="origin"
target_name="origin"
local_repo_path=""
remote_repo_path=""

while getopts "r:b:s:t:h" option; do
  case $option in
    r) remote_repo_path=${OPTARG}
       if [[ "$remote_repo_path" != "git@"* ]]; then
         print 3 "The remote repository path should be an HTTPS address."
         exit 1
       fi
       ;;
    b) if [[ -z "${OPTARG}" ]]; then
         print 3 "The branch name cannot be empty or whitespaces."
         exit 1
       fi
       branch=${OPTARG}
       ;;
    s) if [[ -z "${OPTARG}" ]]; then
         print 3 "The source ref name cannot be empty or whitespaces."
         exit 1
       fi
       source_name=${OPTARG}
       ;;
    t) if [[ -z "${OPTARG}" ]]; then
         print 3 "The target ref name cannot be empty or whitespaces."
         exit 1
       fi
       target_name=${OPTARG}
       ;;
    h) usage
       ;;
  esac
done

shift $((OPTIND-1))

if [[ $# == 1 && ! -z $1 ]]; then
  local_repo_path=$(realpath "$1")
  if [[ $(is-git-repo "$local_repo_path") == $true ]]; then
    print 1 "Redirect to $local_repo_path" && cd "$local_repo_path"
    current_remote_repo_path=$(git ls-remote --get-url)
    if [[ -z $remote_repo_path || $current_remote_repo_path == $remote_repo_path ]]; then
      print 0 "Repository has already existed."

      if [[ -z "$(git status --porcelain)" ]]; then
        print 0 "Current repository is clean."
      else
        if [[ $(choose-yes-or-no "Do you want to commit those changes?") == $true ]]; then
          print 0 "Please provide appropriate message:"
          read commitMessage
          if [[ -z $commitMessage ]]; then
            commitMessage="Save latest changes."
          fi
          git add . && git commit -m "$commitMessage" && git push $target_name $branch
          print 1 "Push changes success."

        else
          print 0 "Save uncommited files to stash list..."
          git stash
        fi
      fi

      if [[ "$source_name" == "$target_name" ]]; then
        # No need to merge.
        print 0 "Pulling latest code..."
        git pull "$target_name" "$branch"
      else
        # git checkout "$source_name/$branch"
        print 0 "Get latest code from "
        git fetch "$source_name" "$branch"
        git merge "$target_name/$branch"
      fi
    else
      print 3 "The current address is $current_remote_repo_path which is not match with the one you provide $remote_repo_path."
      exit 1
    fi
    print 1 "Redirect to original folder" && cd - 1>/dev/null 2>&1
  elif [[ -d $local_repo_path && $(is-folder-empty "$local_repo_path") == $true ]]; then
    print 3 "The folder is not a git repository and it's not empty."
    exit 1
  elif [[ ! -z $remote_repo_path ]]; then
    git clone "$remote_repo_path" "$local_repo_path"
  else
    print 3 "Please provide valid local or remote git repository."
    exit 1
  fi
else
  print 3 "Please provide local folder."
  usage
fi

